<!DOCTYPE html>
<html lang="es-CL">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finaliza tu Compra</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* PALETA DE CORES MERCADO LIBRE */
            --meli-yellow: #ffe600;
            --meli-blue: #3483fa;
            --meli-green-full: #00a650;
            --meli-text: #333333;
            --meli-text-light: #666666;
            --meli-background: #f5f5f5;
            --meli-white: #ffffff;
            --meli-border: #e0e0e0;
            --meli-error: #de3618;
            
            /* MAPEAMENTO PARA VARIÁVEIS GENÉRICAS */
            --primary: var(--meli-blue);
            --success: var(--meli-green-full);
            --error: var(--meli-error);
            --title-color: var(--meli-text);
            --text-color: var(--meli-text);
            --text-light: var(--meli-text-light);
            --border-color: var(--meli-border);
            --input-bg: var(--meli-white);
            --card-bg: var(--meli-white);
            --body-bg: var(--meli-background);
            --sidebar-bg: var(--meli-white);
            --white: var(--meli-white);
            --black: #333333; /* Texto principal */

            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--body-bg);
            color: var(--text-color);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }
        
        .page-header {
            background-color: var(--meli-yellow);
            padding: 1em;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .page-header svg {
            width: 135px;
            height: auto;
        }
        
        .page-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1em;
        }

        .main-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        @media (min-width: 992px) {
            .page-container { padding: 2em 1.5em; }
            .main-content {
                display: grid;
                grid-template-columns: 1fr 420px;
                gap: 0 3em;
            }
            .checkout-flow-container {
                grid-column: 1 / 2;
                grid-row: 1 / 2;
            }
            .sidebar {
                grid-column: 2 / 3;
                grid-row: 1 / 2;
            }
            .summary-card {
                position: sticky;
                top: 2em;
            }
             #summaryCollapsible { display: flex !important; }
            .summary-collapsible-header { display: none !important; }
        }
        
        @media (max-width: 991px) {
            body, html { overflow-y: auto; }
            .page-container { padding: 0; }
            .main-content { padding: 1.5em 1em 120px 1em; }
            .sidebar { order: -1; margin-bottom: 1.5em; }
            .footer-buttons {
                position: fixed; bottom: 0; left: 0; right: 0; z-index: 20;
                background: var(--white); padding: 1em;
                box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
                border-top: 1px solid var(--border-color);
            }
        }

        .progress-bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 2.5em;
            padding: 0 1em;
        }
        .progress-step {
            display: flex; align-items: center; gap: 0.75em;
            color: var(--text-light); font-weight: 500; font-size: 0.9em;
            flex-shrink: 0;
        }
        .step-circle {
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.8em;
            background-color: #dcdcdc; color: var(--text-light);
            transition: all 0.3s;
        }
        .progress-step.active .step-circle { background-color: var(--primary); color: var(--white); }
        .progress-step.active .step-label { color: var(--primary); font-weight: 600; }
        .progress-step.completed .step-circle { background-color: var(--primary); color: var(--white); }
        .progress-step.completed .step-label { color: var(--text-color); }
        
        .progress-step:not(:last-child)::after {
            content: ''; height: 1px; flex-grow: 1;
            background-color: var(--border-color);
            margin: 0 1em;
        }

        .checkout-card { background-color: var(--card-bg); border-radius: var(--border-radius-md); box-shadow: 0 1px 4px rgba(0,0,0,0.05); border: 1px solid var(--border-color); margin-bottom: 1.5em; padding: 1.5em; }
        @media (min-width: 768px) { .checkout-card { padding: 2em; } }
        
        .card-header { margin-bottom: 1.5em; }
        .card-title { font-size: 1.5em; font-weight: 600; color: var(--title-color); margin-bottom: 0.25em; }
        .card-description { font-size: 0.9em; color: var(--text-light); }
        
        #checkoutForm { flex-grow: 1; display:flex; flex-direction:column; }
        .checkout-step { display: none; }
        .checkout-step.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .input-wrapper { position: relative; margin-bottom: 1.25em; }
        .input-label { display: block; font-size: 0.875em; font-weight: 600; margin-bottom: 0.5em; color: var(--title-color); }
        .checkout-input { width: 100%; padding: 0.8em 1em; border: 1.5px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1em; font-family: var(--font-family); transition: all 0.2s ease-in-out; background-color: var(--input-bg); height: 50px; }
        select.checkout-input { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.75em center; background-repeat: no-repeat; background-size: 1.25em 1.25em; padding-right: 2.5em; }
        .checkout-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(52, 131, 250, 0.3); }
        .input-hint { font-size: 0.8em; color: var(--text-light); margin-top: 0.35em; display: block; }
        
        .form-grid { display: grid; gap: 0 1.5em; }
        @media (min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } }
        
        .option-methods-group { margin-top: 2em; }
        .option-methods-title { font-size: 1.125em; font-weight: 700; margin-bottom: 1em; color: var(--title-color); }
        .checkout-radio { display: flex; flex-direction: column; gap: 1em; }
        .checkout-radio label { cursor: pointer; display: block; }
        .checkout-radio input[type="radio"] { display: none; }
        
        .option-card { display: flex; align-items: center; gap: 1em; padding: 1em; border: 2px solid var(--border-color); border-radius: var(--border-radius-md); background: var(--card-bg); transition: all 0.2s ease-in-out; }
        .checkout-radio input[type="radio"]:checked + .option-card { border-color: var(--primary); background-color: rgba(52, 131, 250, 0.05); }
        .checkout-radio label:hover .option-card { border-color: var(--primary); }
        
        .option-card-icon { color: var(--primary); flex-shrink: 0; display: flex; align-items: center; }
        .option-card-icon .full-svg { width: auto; height: 18px; }
        .option-card-main { flex-grow: 1; }
        .option-card-title { font-weight: 600; font-size: 1em; color: var(--title-color); display: flex; align-items: center; gap: 0.5em; }
        .option-card-title .full-svg { margin-left: 0.5em; height: 16px; }
        .option-card-subtitle { font-size: 0.875em; color: var(--success); font-weight: 600; }
        
        .summary-collapsible-header {
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
            padding: 1em; background: #f0f0f0; border-radius: var(--border-radius-md); font-weight: 600;
        }
        #summaryCollapsible { display: none; }

        .summary-card { background: var(--sidebar-bg); border-radius: var(--border-radius-md); padding: 1.5em; border: 1px solid var(--border-color); }
        .summary-title { font-size: 1.2em; font-weight: 600; margin-bottom: 1.5em; }
        .summary-items-list { overflow-y:auto; max-height: 40vh; margin-bottom: 1em; padding-right: 0.5em; }
        .summary-items-list::-webkit-scrollbar { width: 6px; }
        .summary-items-list::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 3px; }
        .summary-item { display: flex; align-items: flex-start; gap: 1em; margin-bottom: 1.5em; }
        .summary-item-img-wrapper {
            position: relative;
            flex-shrink: 0;
        }
        .summary-item-img { width: 64px; height: 64px; border-radius: var(--border-radius-sm); object-fit: cover; background-color: #eee; }
        .summary-item-qty-badge {
            position: absolute; top: -8px; right: -8px;
            background-color: rgba(0,0,0,0.6); color: white;
            border-radius: 50%; width: 22px; height: 22px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.75em; font-weight: 600;
        }
        .summary-item-details { flex: 1; min-width: 0; display: flex; justify-content: space-between; align-items: flex-start; gap: 1em;}
        .summary-item-name { font-weight: 500; font-size: .9em; line-height: 1.4; color: var(--text-color); }
        .summary-item-price { font-weight: 500; white-space: nowrap; font-size: 0.9em; }

        .summary-totals { border-top: 1px solid var(--border-color); padding-top: 1.5em; margin-top: 0.5em; display: flex; flex-direction: column; gap: 0.75em; }
        .summary-line { display: flex; justify-content: space-between; font-size: 0.9em; }
        .summary-line .label { color: var(--text-light); }
        .summary-line .value { font-weight: 600; }
        .summary-line.total { font-size: 1.2em; font-weight: 700; margin-top: 0.5em; }
        
        .coupon-form { display: flex; gap: 0.5em; border-top: 1px solid var(--border-color); padding-top: 1.5em; margin-top: 1.5em; }
        .coupon-form .checkout-input { height: 44px; }
        .coupon-btn { padding: 0 1.25em; height: 44px; border: 0; background-color: transparent; color: var(--primary); border-radius: var(--border-radius-sm); font-weight: 600; cursor: pointer; transition: background-color 0.2s; white-space: nowrap; }
        .coupon-btn:hover { background-color: rgba(52, 131, 250, 0.1); }
        
        .footer-buttons { margin-top: auto; padding-top: 1em; display: flex; flex-direction: column-reverse; gap: 1em; width: 100%; }
        .btn { display: inline-flex; align-items: center; justify-content: center; border-radius: var(--border-radius-sm); font-size: 1em; font-weight: 600; height: 50px; padding: 0 1.5em; cursor: pointer; transition: all 0.2s ease; border: none; text-decoration: none; width: 100%; }
        .btn-primary { background-color: var(--primary); color: var(--white); }
        .btn-primary:hover { background-color: #2968c8; }
        .btn-secondary { background-color: transparent; color: var(--primary); }
        .btn-secondary:hover { background-color: rgba(52, 131, 250, 0.1); }
    </style>
</head>
<body>
    <header class="page-header">
        <svg height="34" viewBox="1338.7 1396.4 150.1 135.8" width="150" xmlns="http://www.w3.org/2000/svg"><path d="m1378.1 1504.2h1.4v28h-5.3v-24.6c0-.8 1.7-3.4 3.9-3.4zm29 6.2c-2.6 0-4.6 1.1-6 3.3v-9.5h-.6c-2.6 0-4 1.4-4.7 2.6v-.2 16.1c0 6.3 3.3 9.5 9.9 9.5 6.6-.1 9.8-3.7 9.8-10.7 0-7.3-2.8-10.9-8.4-11.1zm-1.6 17.2c-3 0-4.5-2.2-4.4-6.4.2-4.1 1.6-6.1 4.5-6.1s4.3 2 4.5 6.1c0 4.3-1.6 6.4-4.6 6.4zm13.1-6.4c.2-6.8 3.5-10.6 10.6-10.6h1.6v5.5h-2.5c-3 0-4.3 1.9-4.3 5v11h-5.4zm20.6 5.5c.9.8 2.1 1.2 3.7 1.2 1.1 0 2.1-.3 2.9-.9s1.3-1.2 1.5-1.8h5c-.8 2.5-2 4.2-3.7 5.3s-3.6 1.6-6 1.6c-1.6 0-3.1-.3-4.4-.8s-2.4-1.3-3.3-2.2c-.9-1-1.6-2.1-2.1-3.4s-.7-2.8-.7-4.4c0-1.5.3-3 .8-4.3s1.2-2.5 2.1-3.4c.9-1 2-1.7 3.3-2.3s2.7-.8 4.3-.8c1.7 0 3.3.3 4.6 1s2.4 1.6 3.2 2.7 1.4 2.4 1.8 3.9c.4 1.4.5 3 .4 4.6h-14.9c.2 1.9.7 3.2 1.5 4zm6.4-10.8c-.7-.7-1.7-1.1-3.1-1.1-.9 0-1.7.2-2.3.5s-1.1.7-1.4 1.1c-.4.5-.6.9-.8 1.4s-.2 1-.3 1.4h9.2c-.1-1.5-.6-2.6-1.3-3.3zm-60.4-11.7h5.3v4.8h-5.3zm0 7.2h5.3v20.7h-5.3zm96.7-18.3c-.9 1-2.1 1.6-3.6 1.6s-2.7-.6-3.6-1.6-1.2-2.7-1.2-4.7c0-2.1.4-3.6 1.2-4.6.9-1 2.1-1.6 3.6-1.6s2.7.6 3.6 1.6 1.2 2.7 1.2 4.6-.3 3.5-1.2 4.7zm4.2-12.4c-1.6-2.1-4.3-3.3-7.8-3.3-3.4 0-6.2 1-7.8 3.3-1.6 2.1-2.6 4.7-2.6 7.6 0 3 .9 5.6 2.6 7.6 1.6 2.1 4.3 3.2 7.8 3.2 3.4 0 6.2-1 7.8-3.2 1.6-2.1 2.6-4.7 2.6-7.6.1-2.8-.8-5.4-2.6-7.6m-26 12.4c-.7 1-1.9 1.6-3.4 1.6s-2.7-.6-3.3-1.6c-.7-1.2-1-2.7-1-4.7 0-1.8.3-3.2 1-4.3.7-1.2 1.8-1.8 3.4-1.8 1 0 1.9.3 2.7.9 1.2 1 1.9 3 1.9 5.6-.3 1.8-.5 3.3-1.3 4.3zm6.2-21.8s-5.4-.6-5.4 3.7v5.7c-.6-.9-1.3-1.6-2.4-2.3-.9-.6-2.1-.7-3.3-.7-2.7 0-4.8 1-6.5 3-1.6 1.9-2.4 4.8-2.4 8.4 0 3 .7 5.6 2.4 7.3 1.6 1.9 4.8 2.7 7.6 2.7 9.9 0 9.7-8.4 9.7-8.4zm-26.6 19.3c0 1.8-.6 3-1.5 3.7-1 .6-2.1 1-3.2 1-.7 0-1.3-.1-1.8-.6s-.7-1-.7-1.9c0-1 .4-1.8 1.2-2.3.4-.3 1.3-.6 2.4-.7l1.2-.3c.6-.1 1-.3 1.5-.3.3-.1.7-.3 1-.4zm2.7-11.7c-1.8-.9-3.7-1.3-6-1.3-3.4 0-5.9.9-7.3 2.7-.9 1.2-1.3 2.6-1.5 4.3h5.1c.1-.7.4-1.3.7-1.8.6-.6 1.5-.9 2.7-.9s1.9.1 2.6.4c.6.3.9.9.9 1.8 0 .7-.4 1.2-1.2 1.5-.4.1-1.2.3-2.1.4l-1.8.1c-2.1.3-3.6.7-4.7 1.3-1.9 1-2.9 3-2.9 5.4 0 1.9.6 3.4 1.8 4.5 1.2 1 2.7 1.5 4.6 1.6 11.7.4 11.6-6.2 11.6-7.5v-7.6c.1-2.2-.7-4-2.5-4.9m-26.5 3.3c1.3 0 2.3.4 3 1.2.4.6.7 1.3.7 2.1h5.7c-.3-2.9-1.3-5-3-6-1.6-1.2-3.9-1.6-6.6-1.6-3.2 0-5.7.9-7.5 2.9s-2.7 4.7-2.7 8.1c0 3.2.7 5.6 2.4 7.5 1.6 1.9 4.2 2.9 7.6 2.9s6-1.2 7.8-3.4c1-1.5 1.6-3 1.8-4.7h-5.7c-.1 1-.4 1.9-1 2.6-.6.6-1.5 1-2.9 1-1.8 0-3.2-.9-3.7-2.6-.3-.9-.6-2.1-.6-3.6s.1-2.9.6-3.7c.9-1.8 2.1-2.7 4.1-2.7m-11.9-4.5c-11.9 0-11.1 10.5-11.1 10.5v10.6h5.4v-9.9c0-1.6.1-2.9.6-3.6.7-1.3 2.1-2.1 4.3-2.1h.6c.3 0 .6 0 .9.1v-5.4h-.4c-.1-.2-.1-.2-.3-.2m-26.8 5.5c.7-.7 1.8-1.2 3.2-1.2 1.2 0 2.3.3 3.2 1s1.3 1.8 1.3 3.2h-9.2c.3-1.2.7-2.2 1.5-3zm7.2 9.9c-.1.3-.4.6-.7.7-.7.6-1.8.7-3 .7s-2.1-.1-2.9-.7c-1.3-.7-2.1-2.3-2.1-4.2h14.8c0-1.8 0-3.2-.1-4-.3-1.6-.7-3-1.6-4.2-.9-1.3-2.1-2.4-3.4-3s-3-.9-4.8-.9c-3 0-5.4.9-7.2 2.9-1.8 1.9-2.9 4.6-2.9 8.1 0 3.7 1 6.5 3.2 8.1 2.1 1.6 4.5 2.6 7.2 2.6 3.3 0 5.9-1 7.6-3 1-1 1.6-2.1 1.8-3.2zm-16.2 5.6h-5v-12.3c0-1.2-.3-3.7-3.6-3.7-2.1 0-3.7 1.5-3.7 3.7v12.3h-5v-12.3c0-1.2-.3-3.7-3.6-3.7-2.1 0-3.6 1.5-3.6 3.7v12.3h-5v-12.2c0-5.1 3.3-9 8.5-9 2.6 0 4.7 1 6.2 2.9 1.5-1.8 3.6-2.9 6.2-2.9 5.4 0 8.5 3.7 8.5 9zm93.3-71.2c0-17.1-21.3-31.1-47.6-31.1s-47.6 14-47.6 31.1v1.8c0 18.2 18.6 32.9 47.6 32.9 29.1 0 47.6-14.7 47.6-32.9z" fill="#2d3277"/><path d="m1459.8 1427.5c0 16.1-20.5 29.2-45.7 29.2s-45.7-13.1-45.7-29.2 20.5-29.2 45.7-29.2 45.7 13.1 45.7 29.2z" fill="#ffe600"/><g fill="#fff"><path d="m1398.9 1418.3s-.5.5-.2.9c.7.9 2.9 1.4 5.2.9 1.3-.3 3.1-1.7 4.7-3 1.8-1.4 3.6-2.9 5.4-3.4 1.9-.6 3.1-.3 3.9-.1.9.3 1.9.9 3.6 2.1 3.1 2.3 15.7 13.3 17.9 15.2 1.7-.8 9.5-4.1 20.1-6.5-.9-5.6-4.3-10.8-9.5-15-7.2 3-16.1 4.6-24.8.4 0 0-4.7-2.2-9.4-2.1-6.9.2-9.8 3.1-13 6.3z"/><path d="m1438.9 1432.1c-.1-.1-14.8-12.9-18.1-15.4-1.9-1.4-3-1.8-4.1-2-.6-.1-1.4 0-2 .2-1.5.4-3.6 1.8-5.4 3.2-1.9 1.5-3.6 2.9-5.2 3.2-2.1.5-4.6-.1-5.7-.9-.5-.3-.8-.7-1-1.1-.4-1 .4-1.8.5-1.9l4-4.4 1.4-1.4c-1.3.2-2.5.5-3.7.8-1.5.4-2.9.8-4.3.8-.6 0-3.8-.5-4.4-.7-3.7-1-6.9-2-11.7-4.2-5.7 4.3-9.6 9.6-10.7 15.5.8.2 2.2.6 2.7.7 13 2.9 17 5.9 17.8 6.5.8-.9 1.9-1.4 3.2-1.4 1.4 0 2.7.7 3.5 1.8.7-.6 1.8-1.1 3.1-1.1.6 0 1.2.1 1.9.3 1.5.5 2.2 1.5 2.6 2.4.5-.2 1.1-.4 1.8-.4s1.4.2 2.2.5c2.4 1 2.8 3.4 2.6 5.2h.5c2.9 0 5.2 2.3 5.2 5.2 0 .9-.2 1.7-.6 2.4.8.4 2.7 1.4 4.5 1.2 1.4-.2 1.9-.6 2.1-.9.1-.2.3-.4.1-.6l-3.7-4.1s-.6-.6-.4-.8.6.1.9.3c1.9 1.6 4.1 3.9 4.1 3.9s.2.3 1 .5c.7.1 2 0 2.9-.7.2-.2.5-.4.6-.6.9-1.2-.1-2.4-.1-2.4l-4.3-4.8s-.6-.6-.4-.8.6.1.9.3c1.4 1.1 3.3 3.1 5.1 4.9.4.3 2 1.3 4.1-.1 1.3-.9 1.6-1.9 1.5-2.7-.1-1-.9-1.8-.9-1.8l-5.8-5.9s-.6-.5-.4-.8c.2-.2.6.1.9.3 1.9 1.6 6.9 6.2 6.9 6.2.1 0 1.8 1.3 4-.1.8-.5 1.3-1.2 1.3-2.1.1-1.3-1-2.2-1-2.2z"/><path d="m1410.6 1439.6c-.9 0-1.9.5-2 .5s0-.4.1-.6 1.3-3.8-1.6-5.1c-2.2-1-3.6.1-4 .6-.1.1-.2.1-.2 0 0-.6-.3-2.4-2.3-3-2.8-.9-4.5 1.1-5 1.8-.2-1.6-1.5-2.8-3.2-2.8-1.8 0-3.2 1.4-3.2 3.2s1.4 3.2 3.2 3.2c.9 0 1.6-.3 2.2-.9v.1c-.1.8-.4 3.7 2.6 4.8 1.2.5 2.2.1 3.1-.5.3-.2.3-.1.3.1-.1.7 0 2.3 2.3 3.2 1.7.7 2.7 0 3.3-.6.3-.3.4-.2.4.2.1 2.1 1.9 3.8 4 3.8 2.2 0 4-1.8 4-4s-1.8-4-4-4z"/></g><path d="m1439.5 1430.6c-4.5-3.9-14.9-13-17.8-15.1-1.6-1.2-2.7-1.9-3.7-2.1-.4-.1-1-.3-1.8-.3-.7 0-1.5.1-2.3.4-1.8.6-3.6 2-5.4 3.4l-.1.1c-1.6 1.3-3.3 2.6-4.6 2.9-.6.1-1.1.2-1.7.2-1.4 0-2.7-.4-3.2-1-.1-.1 0-.3.2-.5l4-4.3c3.1-3.1 6-6 12.8-6.2h.3c4.2 0 8.4 1.9 8.9 2.1 4 1.9 8 2.9 12.1 2.9 4.3 0 8.7-1.1 13.3-3.2-.5-.4-1.1-.9-1.6-1.3-4.1 1.8-7.9 2.6-11.7 2.6s-7.6-.9-11.3-2.7c-.2-.1-4.8-2.3-9.7-2.3h-.4c-5.7.1-8.9 2.1-11 3.9-2.1 0-3.9.6-5.5 1-1.4.4-2.7.7-3.9.7h-1.5c-1.4 0-8.4-1.7-13.9-3.9-.6.4-1.1.8-1.7 1.2 5.8 2.4 12.9 4.2 15.1 4.4.6 0 1.3.1 2 .1 1.5 0 2.9-.4 4.4-.8.9-.2 1.8-.5 2.7-.7l-.8.8-4 4.4c-.3.3-1 1.2-.6 2.2.2.4.6.8 1.1 1.2 1 .6 2.7 1.1 4.3 1.1.6 0 1.2-.1 1.7-.2 1.7-.4 3.5-1.8 5.3-3.3 1.5-1.2 3.6-2.7 5.2-3.2.5-.1 1-.2 1.5-.2h.4c1.1.1 2.1.5 4 1.9 3.3 2.5 18 15.3 18.1 15.4 0 0 .9.8.9 2.2 0 .7-.5 1.4-1.2 1.9-.6.4-1.3.6-1.9.6-1 0-1.7-.5-1.7-.5s-5.1-4.6-6.9-6.2c-.3-.3-.6-.5-.9-.5-.2 0-.3.1-.4.2-.3.4 0 .9.4 1.2l5.9 5.9s.7.7.8 1.6c0 1-.4 1.8-1.4 2.4-.7.5-1.4.7-2.1.7-.9 0-1.5-.4-1.7-.5l-.9-.8c-1.5-1.5-3.1-3.1-4.3-4-.3-.2-.6-.5-.9-.5-.1 0-.3 0-.4.2-.1.1-.2.4.1.9.1.2.3.3.3.3l4.3 4.8s.9 1.1.1 2l-.2.2-.4.4c-.7.6-1.7.7-2.1.7h-.6c-.4-.1-.7-.2-.9-.4-.2-.3-2.4-2.4-4.2-3.9-.2-.2-.5-.4-.8-.4-.1 0-.3.1-.4.2-.3.4.2 1 .4 1.2l3.7 4s0 .1-.1.3-.6.6-1.9.8h-.5c-1.4 0-2.8-.7-3.6-1.1.3-.7.5-1.5.5-2.3 0-3-2.4-5.4-5.4-5.4h-.2c.1-1.4-.1-4-2.8-5.1-.8-.3-1.5-.5-2.3-.5-.6 0-1.1.1-1.7.3-.6-1.1-1.5-1.9-2.7-2.3-.7-.2-1.3-.3-2-.3-1.1 0-2.1.3-3 1a4.6 4.6 0 0 0 -3.6-1.7c-1.2 0-2.4.5-3.2 1.3-1.1-.9-5.6-3.7-17.7-6.5-.6-.1-1.9-.5-2.7-.8-.1.6-.2 1.3-.3 2 0 0 2.2.5 2.7.6 12.3 2.7 16.4 5.6 17.1 6.1-.2.6-.3 1.2-.3 1.8 0 2.6 2.1 4.6 4.6 4.6.3 0 .6 0 .9-.1.4 1.9 1.6 3.3 3.5 4 .6.2 1.1.3 1.6.3.3 0 .7 0 1.1-.1.3.9 1.1 2 2.9 2.7.6.3 1.2.4 1.8.4.5 0 1-.1 1.4-.3.8 2 2.8 3.4 5 3.4 1.5 0 2.9-.6 3.9-1.7.9.5 2.7 1.4 4.6 1.4h.7c1.9-.2 2.7-1 3.1-1.5.1-.1.1-.2.2-.3.4.1.9.2 1.5.2 1 0 2-.3 3-1.1 1-.7 1.7-1.7 1.7-2.6.3.1.7.1 1 .1 1 0 2.1-.3 3.1-1 1.9-1.2 2.2-2.9 2.2-3.9.3.1.7.1 1 .1 1 0 2-.3 2.9-.9 1.2-.8 1.9-1.9 2-3.2.1-.9-.2-1.8-.6-2.6 3.2-1.4 10.4-4 19-6 0-.7-.1-1.3-.3-2-10.3 2.2-18 5.5-19.9 6.4zm-28.9 16.7c-2 0-3.6-1.6-3.7-3.6 0-.2 0-.6-.4-.6-.2 0-.3.1-.5.2-.4.4-1 .8-1.8.8-.4 0-.8-.1-1.2-.3-2.1-.9-2.2-2.3-2.1-2.9 0-.2 0-.3-.1-.4l-.1-.1h-.1c-.1 0-.2 0-.4.2-.6.4-1.2.6-1.8.6-.3 0-.7-.1-1-.2-2.8-1.1-2.6-3.7-2.4-4.5 0-.2 0-.3-.1-.4l-.2-.2-.2.2c-.6.5-1.3.8-2 .8-1.6 0-2.9-1.3-2.9-2.9s1.3-2.9 2.9-2.9c1.4 0 2.7 1.1 2.9 2.5l.1.8.4-.7c0-.1 1.2-1.9 3.4-1.8.4 0 .8.1 1.3.2 1.7.5 2 2.1 2 2.7 0 .4.3.4.3.4.1 0 .3-.1.3-.2.3-.3 1-.9 2.1-.9.5 0 1 .1 1.6.4 2.7 1.2 1.5 4.6 1.5 4.7-.2.6-.3.8 0 1h.2c.1 0 .3 0 .5-.1.4-.1.9-.3 1.4-.3 2 0 3.7 1.7 3.7 3.7.1 2.2-1.6 3.8-3.6 3.8z" fill="#2d3277"/></svg>
    </header>

    <div class="page-container">
        <main class="main-content">
            <aside class="sidebar">
                <div class="summary-collapsible-header" id="summaryHeader">
                    <span>Mostrar resumen de la compra</span>
                    <span class="total-price-preview"></span>
                </div>
                <div class="summary-card" id="summaryCollapsible">
                    <h2 class="summary-title">Resumen de tu compra</h2>
                    <div class="summary-items-list" id="summary-items-list"><p>Cargando tu carrito...</p></div>
                    <div class="summary-totals">
                        <div class="summary-line"><span class="label">Subtotal</span><span class="value" id="summary-subtotal"></span></div>
                        <div class="summary-line"><span class="label">Envío</span><span class="value" id="summary-shipping">Gratis</span></div>
                        <div class="summary-line total"><span class="label">Total</span><span class="value" id="summary-total"></span></div>
                    </div>
                    <form class="coupon-form">
                        <input type="text" class="checkout-input" placeholder="Cupón de descuento">
                        <button type="button" class="coupon-btn">Aplicar</button>
                    </form>
                </div>
            </aside>

            <div class="checkout-flow-container">
                <div class="progress-bar-container"></div>
                
                <form id="checkoutForm" novalidate>
                    </form>
                
                <div class="footer-buttons">
                    <button type="button" class="btn btn-primary" id="nextButton">Continuar</button>
                    <button type="button" class="btn btn-secondary" id="backButton" style="display: none;">Volver</button>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        function injectFormHTML() {
            const formContainer = document.getElementById('checkoutForm');
            if (!formContainer) return;
            formContainer.innerHTML = `
                <div class="checkout-step" id="step1-content">
                    <div class="checkout-card">
                        <div class="card-header"><h2 class="card-title">Datos de Contacto</h2></div>
                        <div class="input-wrapper">
                            <label class="input-label" for="email">Correo electrónico</label>
                            <input id="email" type="email" class="checkout-input" placeholder="tucorreo@ejemplo.com" required>
                        </div>
                        <div class="form-grid">
                            <div class="input-wrapper">
                                <label class="input-label" for="name">Nombre y Apellido</label>
                                <input id="name" type="text" class="checkout-input" placeholder="Tu nombre y apellido" required>
                            </div>
                            <div class="input-wrapper">
                                <label class="input-label" for="rut">RUT</label>
                                <input id="rut" type="text" class="checkout-input" placeholder="12.345.678-9" required>
                            </div>
                        </div>
                        <div class="input-wrapper">
                            <label class="input-label" for="phone">Teléfono</label>
                            <input id="phone" type="tel" class="checkout-input" placeholder="9 1234 5678" required>
                            <span class="input-hint">Lo usaremos para contactarte sobre tu pedido.</span>
                        </div>
                    </div>
                </div>

                <div class="checkout-step" id="step2-content">
                    <div class="checkout-card">
                        <div class="card-header"><h2 class="card-title">Dirección de Entrega</h2></div>
                        <div class="input-wrapper">
                            <label class="input-label" for="address">Dirección</label>
                            <input id="address" type="text" class="checkout-input" placeholder="Calle, Número, Depto." required>
                        </div>
                        <div class="form-grid">
                            <div class="input-wrapper">
                                <label class="input-label" for="region">Región</label>
                                <select id="region" class="checkout-input" required>
                                    <option value="" disabled selected>Selecciona tu región</option>
                                    <option value="AP">Arica y Parinacota</option> <option value="TA">Tarapacá</option> <option value="AN">Antofagasta</option>
                                    <option value="AT">Atacama</option> <option value="CO">Coquimbo</option> <option value="VA">Valparaíso</option>
                                    <option value="RM">Metropolitana de Santiago</option> <option value="OH">O'Higgins</option> <option value="MA">Maule</option>
                                    <option value="NB">Ñuble</option> <option value="BI">Biobío</option> <option value="AR">La Araucanía</option>
                                    <option value="LR">Los Ríos</option> <option value="LL">Los Lagos</option> <option value="AI">Aysén</option> <option value="MG">Magallanes</option>
                                </select>
                            </div>
                            <div class="input-wrapper">
                                <label class="input-label" for="postal">Código postal (Opcional)</label>
                                <input id="postal" type="text" class="checkout-input" placeholder="Ej: 8340457">
                            </div>
                        </div>
                        <div class="option-methods-group">
                            <h3 class="option-methods-title">Método de Entrega</h3>
                            <div class="checkout-radio">
                                <label>
                                    <input type="radio" name="delivery" value="domicilio" checked>
                                    <div class="option-card">
                                        <div class="option-card-main">
                                            <div class="option-card-title">
                                                Envío Full
                                                <svg class="full-svg" xmlns="http://www.w3.org/1999/xlink" viewBox="0 0 41 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M2.628 0h5.255L5.255 4.643h4.38L2.628 13l1.751-5.571H0L2.628 0zm11.589 9.533h-1.959l1.674-7.515H19.5l-.376 1.69h-3.61l-.25 1.172h3.519l-.376 1.69h-3.53l-.66 2.963zm9.468.136c-2.334 0-3.484-1.105-3.484-2.682 0-.124.034-.383.057-.496l1.002-4.473h1.992l-.99 4.428c-.012.057-.034.18-.034.316.011.62.49 1.217 1.457 1.217 1.048 0 1.583-.654 1.776-1.533l.991-4.428h1.981l-.99 4.462c-.41 1.825-1.412 3.189-3.758 3.189zm10.118-.136h-5.01l1.673-7.515h1.959l-1.287 5.825h3.04l-.375 1.69zm6.678 0h-5.01l1.674-7.515h1.959l-1.287 5.825h3.04l-.376 1.69z" fill-opacity="1" fill="#00a650"></path>
                                                </svg>
                                            </div>
                                            <div class="option-card-subtitle">Llega entre 24 y 48 horas</div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="checkout-step" id="step3-content">
                    <div class="checkout-card">
                        <div class="card-header">
                            <h2 class="card-title">Pago</h2>
                            <p class="card-description">Todas las transacciones son seguras y están encriptadas.</p>
                        </div>
                        <div class="checkout-radio">
                            <label><input type="radio" name="pago" value="tarjeta" checked><div class="option-card"><div class="option-card-main"><div class="option-card-title">Tarjeta de Crédito o Débito</div></div></div></label>
                            <label><input type="radio" name="pago" value="transferencia"><div class="option-card"><div class="option-card-main"><div class="option-card-title">Transferencia Bancaria</div></div></div></label>
                        </div>
                    </div>
                </div>`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            injectFormHTML();

            let currentStep = 1;
            const totalSteps = 3;
            const nextButton = document.getElementById('nextButton');
            const backButton = document.getElementById('backButton');
            const progressBarContainer = document.querySelector('.progress-bar-container');
            const summaryHeader = document.getElementById('summaryHeader');
            const summaryCollapsible = document.getElementById('summaryCollapsible');

            if (summaryHeader) {
                summaryHeader.addEventListener('click', () => {
                    const isHidden = summaryCollapsible.style.display === 'none' || summaryCollapsible.style.display === '';
                    summaryCollapsible.style.display = isHidden ? 'flex' : 'none';
                    summaryHeader.children[0].textContent = isHidden ? 'Ocultar resumen' : 'Mostrar resumen de la compra';
                });
            }
            
            function formatCurrency(value) {
                return (value / 100).toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
            }

            function populateSummary(cartData) {
                const itemsList = document.getElementById('summary-items-list');
                const subtotalEl = document.getElementById('summary-subtotal');
                const totalEl = document.getElementById('summary-total');
                const totalPreviewEl = document.querySelector('.total-price-preview');
                itemsList.innerHTML = '';

                if (!cartData || !cartData.items || cartData.items.length === 0) {
                    itemsList.innerHTML = '<p>No hay artículos en tu carrito.</p>';
                    return;
                }
                
                cartData.items.forEach(item => {
                    itemsList.innerHTML += `
                        <div class="summary-item">
                            <div class="summary-item-img-wrapper">
                                <img src="${item.image || ''}" alt="${item.title}" class="summary-item-img">
                                <span class="summary-item-qty-badge">${item.quantity || 1}</span>
                            </div>
                            <div class="summary-item-details">
                                <div class="summary-item-name" title="${item.title}">${item.title}</div>
                                <div class="summary-item-price">${formatCurrency(item.price)}</div>
                            </div>
                        </div>`;
                });
                
                const totalFormatted = formatCurrency(cartData.total_price);
                subtotalEl.textContent = totalFormatted;
                totalEl.textContent = totalFormatted;
                if (totalPreviewEl) totalPreviewEl.textContent = totalFormatted;
            }

            function updateProgressBar() {
                progressBarContainer.innerHTML = '';
                const stepLabels = ['Contacto', 'Entrega', 'Pago'];
                for (let i = 1; i <= totalSteps; i++) {
                    const stepEl = document.createElement('div');
                    stepEl.className = 'progress-step';
                    if (i < currentStep) stepEl.classList.add('completed');
                    if (i === currentStep) stepEl.classList.add('active');
                    
                    const checkMark = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                    stepEl.innerHTML = `<div class="step-circle">${i < currentStep ? checkMark : i}</div><div class="step-label">${stepLabels[i - 1]}</div>`;
                    
                    progressBarContainer.appendChild(stepEl);
                    if (i < totalSteps) {
                         const connector = document.createElement('div');
                         connector.style.flexGrow = '1';
                         connector.style.height = '1px';
                         connector.style.backgroundColor = 'var(--border-color)';
                         connector.style.margin = '0 0.5em';
                         // progressBarContainer.appendChild(connector); // Desabilitado para um layout mais limpo
                    }
                }
            }

            function updateButtons() {
                backButton.style.display = currentStep > 1 ? 'inline-flex' : 'none';
                if (currentStep === 1) nextButton.textContent = 'Continuar';
                else if (currentStep === 2) nextButton.textContent = 'Continuar';
                else if (currentStep === totalSteps) nextButton.textContent = 'Finalizar Compra';
            }

            function changeStep(step) {
                if (step < 1 || step > totalSteps) return;
                
                const activeStep = document.querySelector('.checkout-step.active');
                if (activeStep) activeStep.classList.remove('active');
                
                currentStep = step;
                const newActiveStep = document.getElementById(`step${currentStep}-content`);
                if (newActiveStep) newActiveStep.classList.add('active');

                updateProgressBar();
                updateButtons();
                window.scrollTo(0, 0);
            }

            function validateStep(step) {
                const contentId = `step${step}-content`;
                const inputs = document.querySelectorAll(`#${contentId} [required]`);
                let isValid = true;
                inputs.forEach(input => {
                    input.style.borderColor = ''; // Reset border color
                    if (input.offsetParent !== null && !input.value.trim()) {
                        isValid = false;
                        input.style.borderColor = 'var(--error)';
                    }
                });
                if (!isValid) {
                    const firstError = document.querySelector(`#${contentId} [required][style*="var(--error)"]`);
                    if (firstError) firstError.focus();
                }
                return isValid;
            }
            
            nextButton.addEventListener('click', () => {
                if (!validateStep(currentStep)) return;
                if (currentStep < totalSteps) {
                    changeStep(currentStep + 1);
                } else {
                    // Simula o processamento e redireciona
                    nextButton.textContent = 'Procesando...';
                    nextButton.disabled = true;
                    setTimeout(() => {
                        parent.postMessage({ type: 'redirect-to-checkout', message: "https://www.mercadolibre.cl/gracias", origin: 'iugu-checkout' }, '*');
                    }, 1500);
                }
            });

            backButton.addEventListener('click', () => { changeStep(currentStep - 1); });

            window.addEventListener('message', (event) => {
                if (event.data.type === 'receive-cart-info') {
                    populateSummary(event.data.message);
                    parent.postMessage({ type: 'iframe-loaded', message: true, origin: 'iugu-checkout' }, '*');
                }
            });
            
            document.querySelectorAll('#checkoutForm .checkout-input[required]').forEach(input => {
                input.addEventListener('input', () => {
                    if (input.value.trim()) input.style.borderColor = '';
                });
            });

            const rutInput = document.getElementById('rut');
            if (rutInput) {
                rutInput.addEventListener('input', function() {
                    let value = this.value.replace(/[^0-9kK.-]/g, '');
                    this.value = value;
                });
                rutInput.addEventListener('blur', function() {
                    let value = this.value.replace(/[.-]/g, '');
                    if (value.length > 1) {
                        let body = value.slice(0, -1);
                        let dv = value.slice(-1).toUpperCase();
                        let formattedBody = body.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                        this.value = formattedBody + '-' + dv;
                    }
                });
            }

            changeStep(1); // Inicia na primeira etapa
        });
    </script>
</body>
</html>